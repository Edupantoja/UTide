
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>utide._solve &#8212; UTide 0.2.6.dev26+gdf2f77b documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">UTide 0.2.6.dev26+gdf2f77b documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">utide._solve</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for utide._solve</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Central module for calculating the tidal amplitudes, phases, etc.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">._time_conversion</span> <span class="kn">import</span> <span class="n">_normalize_time</span>
<span class="kn">from</span> <span class="nn">._ut_constants</span> <span class="kn">import</span> <span class="n">constit_index_dict</span>
<span class="kn">from</span> <span class="nn">.confidence</span> <span class="kn">import</span> <span class="n">_confidence</span>
<span class="kn">from</span> <span class="nn">.constituent_selection</span> <span class="kn">import</span> <span class="n">ut_cnstitsel</span>
<span class="kn">from</span> <span class="nn">.diagnostics</span> <span class="kn">import</span> <span class="n">ut_diagn</span>
<span class="kn">from</span> <span class="nn">.ellipse_params</span> <span class="kn">import</span> <span class="n">ut_cs2cep</span>
<span class="kn">from</span> <span class="nn">.harmonics</span> <span class="kn">import</span> <span class="n">ut_E</span>
<span class="kn">from</span> <span class="nn">.robustfit</span> <span class="kn">import</span> <span class="n">robustfit</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">Bunch</span>


<span class="n">default_opts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;constit&quot;</span><span class="p">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="s2">&quot;conf_int&quot;</span><span class="p">:</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;ols&quot;</span><span class="p">,</span>
    <span class="s2">&quot;trend&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;Greenwich&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nodal&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;infer&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;MC_n&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="s2">&quot;Rayleigh_min&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;robust_kw&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;weight_function&quot;</span><span class="p">:</span> <span class="s2">&quot;cauchy&quot;</span><span class="p">},</span>
    <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_process_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">is_2D</span><span class="p">):</span>
    <span class="n">newopts</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">default_opts</span><span class="p">)</span>
    <span class="n">newopts</span><span class="o">.</span><span class="n">update_values</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="c1"># TODO: add more validations.</span>
    <span class="n">newopts</span><span class="o">.</span><span class="n">infer</span> <span class="o">=</span> <span class="n">validate_infer</span><span class="p">(</span><span class="n">newopts</span><span class="o">.</span><span class="n">infer</span><span class="p">,</span> <span class="n">is_2D</span><span class="p">)</span>

    <span class="n">compat_opts</span> <span class="o">=</span> <span class="n">_translate_opts</span><span class="p">(</span><span class="n">newopts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">compat_opts</span>


<span class="k">def</span> <span class="nf">_translate_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">):</span>
    <span class="c1"># Temporary shim between new-style options and Matlab heritage.</span>
    <span class="c1"># Here or elsewhere, proper validation remains to be added.</span>
    <span class="n">oldopts</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">()</span>
    <span class="n">oldopts</span><span class="o">.</span><span class="n">cnstit</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">constit</span>
    <span class="n">oldopts</span><span class="o">.</span><span class="n">infer</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">infer</span>  <span class="c1"># we will not use the matlab names, though</span>

    <span class="n">oldopts</span><span class="o">.</span><span class="n">conf_int</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="o">.</span><span class="n">linci</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;MC&quot;</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="o">.</span><span class="n">linci</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">conf_int</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="o">.</span><span class="n">conf_int</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">oldopts</span><span class="o">.</span><span class="n">nodiagn</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;conf_int&#39; must be &#39;linear&#39;, &#39;MC&#39;, or &#39;none&#39;&quot;</span><span class="p">)</span>

    <span class="n">oldopts</span><span class="o">.</span><span class="n">notrend</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">trend</span>
    <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;nodesatlint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;nodesatnone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;gwchlint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;gwchnone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">nodal</span> <span class="o">==</span> <span class="s2">&quot;linear_time&quot;</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;nodsatlint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">nodal</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;nodsatnone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;linear_time&quot;</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;gwchlint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">opts</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
        <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;gwchnone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Otherwise it should be default, &#39;Greenwich.&#39;</span>
    <span class="n">oldopts</span><span class="o">.</span><span class="n">rmin</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">Rayleigh_min</span>
    <span class="n">oldopts</span><span class="o">.</span><span class="n">white</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">white</span>
    <span class="n">oldopts</span><span class="o">.</span><span class="n">newopts</span> <span class="o">=</span> <span class="n">opts</span>  <span class="c1"># So we can access new opts via the single &quot;opt.&quot;</span>
    <span class="n">oldopts</span><span class="p">[</span><span class="s2">&quot;RunTimeDisp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span>
    <span class="n">oldopts</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">epoch</span>
    <span class="k">return</span> <span class="n">oldopts</span>


<span class="k">def</span> <span class="nf">validate_infer</span><span class="p">(</span><span class="n">infer</span><span class="p">,</span> <span class="n">is_2D</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">infer</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">infer</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">required_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;inferred_names&quot;</span><span class="p">,</span> <span class="s2">&quot;reference_names&quot;</span><span class="p">,</span> <span class="s2">&quot;amp_ratios&quot;</span><span class="p">,</span> <span class="s2">&quot;phase_offsets&quot;</span><span class="p">}</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">infer</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">keys</span> <span class="o">&lt;</span> <span class="n">required_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;infer option must include </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">required_keys</span><span class="p">)</span>
    <span class="n">nI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">infer</span><span class="o">.</span><span class="n">inferred_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">infer</span><span class="o">.</span><span class="n">reference_names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nI</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;inferred_names must be same&quot;</span> <span class="s2">&quot;  length as reference_names&quot;</span><span class="p">)</span>
    <span class="n">nratios</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nI</span> <span class="k">if</span> <span class="n">is_2D</span> <span class="k">else</span> <span class="n">nI</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">infer</span><span class="o">.</span><span class="n">amp_ratios</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nratios</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">infer</span><span class="o">.</span><span class="n">phase_offsets</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nratios</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ratios and offsets need to have length </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nratios</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;approximate&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">infer</span><span class="p">:</span>
        <span class="n">infer</span><span class="o">.</span><span class="n">approximate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">infer</span>


<div class="viewcode-block" id="solve"><a class="viewcode-back" href="../../usage.html#utide.solve">[docs]</a><span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate amplitude, phase, confidence intervals of tidal constituents.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : array_like</span>
<span class="sd">        Time in days since `epoch`.</span>
<span class="sd">    u : array_like</span>
<span class="sd">        Sea-surface height, velocity component, etc.</span>
<span class="sd">    v : {None, array_like}, optional</span>
<span class="sd">        If `u` is a velocity component, `v` is the orthogonal component.</span>
<span class="sd">    lat : float, required</span>
<span class="sd">        Latitude in degrees.</span>
<span class="sd">    epoch : {string, `datetime.date`, `datetime.datetime`}, optional</span>
<span class="sd">        Valid strings are &#39;python&#39; (default); &#39;matlab&#39; if `t` is</span>
<span class="sd">        an array of Matlab datenums; or an arbitrary date in the</span>
<span class="sd">        form &#39;YYYY-MM-DD&#39;.  The default corresponds to the Python</span>
<span class="sd">        standard library `datetime` proleptic Gregorian calendar,</span>
<span class="sd">        starting with 1 at 00:00 on January 1 of year 1; this is</span>
<span class="sd">        the &#39;datenum&#39; used by Matplotlib.</span>
<span class="sd">    constit : {&#39;auto&#39;, array_like}, optional</span>
<span class="sd">        List of strings with standard letter abbreviations of</span>
<span class="sd">        tidal constituents; or &#39;auto&#39; to let the list be determined</span>
<span class="sd">        based on the time span.</span>
<span class="sd">    conf_int : {&#39;linear&#39;, &#39;MC&#39;, &#39;none&#39;}, optional</span>
<span class="sd">        If not &#39;none&#39; (string), calculate linearized confidence</span>
<span class="sd">        intervals, or use a Monte-Carlo simulation.</span>
<span class="sd">    method : {&#39;ols&#39;, &#39;robust&#39;}, optional</span>
<span class="sd">        Solve with ordinary least squares, or with a robust algorithm.</span>
<span class="sd">    trend : bool, optional</span>
<span class="sd">        True (default) to include a linear trend in the model.</span>
<span class="sd">    phase : {&#39;Greenwich&#39;, &#39;linear_time&#39;, &#39;raw&#39;}, optional</span>
<span class="sd">        Give Greenwich-referenced phase lags, an approximation</span>
<span class="sd">        using linearized times, or raw lags.</span>
<span class="sd">    nodal : {True, False, &#39;linear_time&#39;}, optional</span>
<span class="sd">        True (default) to include nodal/satellite corrections;</span>
<span class="sd">        &#39;linear_time&#39; to use the linearized time approximation;</span>
<span class="sd">        False to omit nodal corrections.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coef : Bunch</span>
<span class="sd">        Data container with all configuration and solution information:</span>

<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    infer : {None, dict or Bunch}, optional; default is None.</span>
<span class="sd">        If not None, the items are:</span>

<span class="sd">        **inferred_names** : {sequence of N strings}</span>
<span class="sd">            inferred constituent names</span>
<span class="sd">        **reference_names** : {sequence of N strings}</span>
<span class="sd">            reference constituent names</span>
<span class="sd">        **amp_ratios** : {sequence, N or 2N floats}</span>
<span class="sd">            amplitude ratios (unitless)</span>
<span class="sd">        **phase_offsets** : {sequence, N or 2N floats}</span>
<span class="sd">            phase offsets (degrees)</span>
<span class="sd">        **approximate** : {bool, optional (default is False)}</span>
<span class="sd">            use approximate method</span>

<span class="sd">        amp_ratios and phase_offsets have length N for a scalar</span>
<span class="sd">        time series, or 2N for a vector series.</span>

<span class="sd">    MC_n : integer, optional</span>
<span class="sd">        Not yet implemented.</span>
<span class="sd">    robust_kw : dict, optional</span>
<span class="sd">        Keyword arguments for `robustfit`, if `method` is &#39;robust&#39;.</span>
<span class="sd">    Rayleigh_min : float</span>
<span class="sd">        Minimum conventional Rayleigh criterion for automatic</span>
<span class="sd">        constituent selection; default is 1.</span>
<span class="sd">    white : bool</span>
<span class="sd">        If False (default), use band-averaged spectra from the</span>
<span class="sd">        residuals in the confidence limit estimates; if True,</span>
<span class="sd">        assume a white background spectrum.</span>
<span class="sd">    verbose : {True, False}, optional</span>
<span class="sd">        True (default) turns on verbose output. False emits no messages.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    `utide.reconstruct` requires the calculation of confidence intervals.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    To be added: much additional explanation.</span>

<span class="sd">    There will also be more &quot;Other Parameters&quot;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">compat_opts</span> <span class="o">=</span> <span class="n">_process_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">coef</span> <span class="o">=</span> <span class="n">_solv1</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">compat_opts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coef</span></div>


<span class="k">def</span> <span class="nf">_solv1</span><span class="p">(</span><span class="n">tin</span><span class="p">,</span> <span class="n">uin</span><span class="p">,</span> <span class="n">vin</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>

    <span class="c1"># The following returns a possibly modified copy of tin (ndarray).</span>
    <span class="c1"># t, u, v are fully edited ndarrays (unless v is None).</span>
    <span class="n">packed</span> <span class="o">=</span> <span class="n">_slvinit</span><span class="p">(</span><span class="n">tin</span><span class="p">,</span> <span class="n">uin</span><span class="p">,</span> <span class="n">vin</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="n">tin</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">lor</span><span class="p">,</span> <span class="n">elor</span><span class="p">,</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">packed</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;RunTimeDisp&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solve: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># opt[&#39;cnstit&#39;] = cnstit</span>
    <span class="n">cnstit</span><span class="p">,</span> <span class="n">coef</span> <span class="o">=</span> <span class="n">ut_cnstitsel</span><span class="p">(</span>
        <span class="n">tref</span><span class="p">,</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;rmin&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="n">lor</span><span class="p">),</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;cnstit&quot;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;infer&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># a function we don&#39;t need</span>
    <span class="c1"># coef.aux.rundescr = ut_rundescr(opt,nNR,nR,nI,t,tgd,uvgd,lat)</span>

    <span class="n">coef</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
    <span class="n">coef</span><span class="o">.</span><span class="n">aux</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>

    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;RunTimeDisp&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matrix prep ... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">ngflgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodsatlint&quot;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodsatnone&quot;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;gwchlint&quot;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;gwchnone&quot;</span><span class="p">]]</span>

    <span class="n">E_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">ngflgs</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">prefilt</span><span class="p">)</span>

    <span class="c1"># Make the model array, starting with the harmonics.</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">ut_E</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">cnstit</span><span class="o">.</span><span class="n">NR</span><span class="o">.</span><span class="n">frq</span><span class="p">,</span> <span class="n">cnstit</span><span class="o">.</span><span class="n">NR</span><span class="o">.</span><span class="n">lind</span><span class="p">,</span> <span class="o">*</span><span class="n">E_args</span><span class="p">)</span>

    <span class="c1"># Positive and negative frequencies</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">E</span><span class="p">,</span> <span class="n">E</span><span class="o">.</span><span class="n">conj</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">infer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">Etilp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">coef</span><span class="o">.</span><span class="n">nR</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">Etilm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">coef</span><span class="o">.</span><span class="n">nR</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">approximate</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnstit</span><span class="o">.</span><span class="n">R</span><span class="p">):</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">ut_E</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">frq</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">lind</span><span class="p">,</span> <span class="o">*</span><span class="n">E_args</span><span class="p">)</span>
                <span class="c1"># (nt,1)</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">ut_E</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">frq</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">lind</span><span class="p">,</span> <span class="o">*</span><span class="n">E_args</span><span class="p">)</span> <span class="o">/</span> <span class="n">E</span>
                <span class="c1"># (nt,ni)</span>
                <span class="n">Qsum_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">Rp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Etilp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Qsum_p</span><span class="p">)</span>
                <span class="n">Qsum_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">Rm</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Etilm</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Qsum_m</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Approximate inference.</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">nR</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">nR</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnstit</span><span class="o">.</span><span class="n">R</span><span class="p">):</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">ut_E</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">frq</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">lind</span><span class="p">,</span> <span class="o">*</span><span class="n">E_args</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">Etilp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span>
                <span class="n">Etilm</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">ut_E</span><span class="p">(</span><span class="n">tref</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">frq</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">lind</span><span class="p">,</span> <span class="o">*</span><span class="n">E_args</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                <span class="n">den</span> <span class="o">=</span> <span class="n">ut_E</span><span class="p">(</span><span class="n">tref</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">frq</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">lind</span><span class="p">,</span> <span class="o">*</span><span class="n">E_args</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">lor</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">frq</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">frq</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nt</span>
                <span class="n">beta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">/</span> <span class="n">arg</span>

        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">Etilp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Etilm</span><span class="p">)))</span>

    <span class="c1"># add the mean</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;notrend&quot;</span><span class="p">]:</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">tref</span><span class="p">)</span> <span class="o">/</span> <span class="n">lor</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>

    <span class="c1"># nm = B.shape[1]  # 2*(nNR + nR) + 1, plus 1 if trend is included.</span>

    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;RunTimeDisp&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution ... &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;twodim&quot;</span><span class="p">]:</span>
        <span class="n">xraw</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">v</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xraw</span> <span class="o">=</span> <span class="n">u</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">newopts</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ols&quot;</span><span class="p">:</span>
        <span class="c1"># Model coefficients.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">xraw</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">xraw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>  <span class="c1"># Uniform weighting; we could use a scalar 1, or None.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">robustfit</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">xraw</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="o">.</span><span class="n">newopts</span><span class="o">.</span><span class="n">robust_kw</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">b</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">w</span>
        <span class="n">coef</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>
    <span class="n">coef</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">W</span>

    <span class="n">xmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>  <span class="c1"># Model fit.</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;twodim&quot;</span><span class="p">]:</span>
        <span class="n">xmod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">xmod</span><span class="p">)</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="p">(</span><span class="n">xraw</span> <span class="o">-</span> <span class="n">xmod</span><span class="p">)</span>  <span class="c1"># Weighted residuals.</span>

    <span class="n">nI</span><span class="p">,</span> <span class="n">nR</span><span class="p">,</span> <span class="n">nNR</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">nI</span><span class="p">,</span> <span class="n">coef</span><span class="o">.</span><span class="n">nR</span><span class="p">,</span> <span class="n">coef</span><span class="o">.</span><span class="n">nNR</span>

    <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">m</span><span class="p">[:</span><span class="n">nNR</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nNR</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nNR</span> <span class="o">+</span> <span class="n">nR</span><span class="p">]))</span>
    <span class="n">i0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nNR</span> <span class="o">+</span> <span class="n">nR</span>
    <span class="n">am</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="n">nNR</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nNR</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="n">i0</span> <span class="p">:</span> <span class="n">i0</span> <span class="o">+</span> <span class="n">nR</span><span class="p">]))</span>

    <span class="n">Xu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">am</span><span class="p">)</span>
    <span class="n">Yu</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">ap</span> <span class="o">-</span> <span class="n">am</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;twodim&quot;</span><span class="p">]:</span>
        <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut_cs2cep</span><span class="p">(</span><span class="n">Xu</span><span class="p">,</span> <span class="n">Yu</span><span class="p">)</span>
        <span class="n">Xv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Yv</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">Xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">ap</span> <span class="o">+</span> <span class="n">am</span><span class="p">)</span>
        <span class="n">Yv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">ap</span> <span class="o">-</span> <span class="n">am</span><span class="p">)</span>
        <span class="n">packed</span> <span class="o">=</span> <span class="n">ut_cs2cep</span><span class="p">(</span><span class="n">Xu</span><span class="p">,</span> <span class="n">Yu</span><span class="p">,</span> <span class="n">Xv</span><span class="p">,</span> <span class="n">Yv</span><span class="p">)</span>
        <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmaj&quot;</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmin&quot;</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">],</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">packed</span>

    <span class="c1"># Mean and trend.</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;twodim&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;notrend&quot;</span><span class="p">]:</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;umean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;vmean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;umean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;vmean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;uslope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">lor</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;vslope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">lor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;notrend&quot;</span><span class="p">]:</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">lor</span>

    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">infer</span><span class="p">:</span>
        <span class="c1"># complex coefficients</span>
        <span class="n">apI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nI</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">amI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nI</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cnstit</span><span class="o">.</span><span class="n">R</span><span class="p">):</span>
            <span class="n">apI</span><span class="p">[</span><span class="n">ind</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">nI</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">Rp</span> <span class="o">*</span> <span class="n">ap</span><span class="p">[</span><span class="n">nNR</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">amI</span><span class="p">[</span><span class="n">ind</span> <span class="p">:</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">nI</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">Rm</span> <span class="o">*</span> <span class="n">am</span><span class="p">[</span><span class="n">nNR</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="n">ref</span><span class="o">.</span><span class="n">nI</span>

        <span class="n">XuI</span> <span class="o">=</span> <span class="p">(</span><span class="n">apI</span> <span class="o">+</span> <span class="n">amI</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
        <span class="n">YuI</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">apI</span> <span class="o">-</span> <span class="n">amI</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">twodim</span><span class="p">:</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">ut_cs2cep</span><span class="p">(</span><span class="n">XuI</span><span class="p">,</span> <span class="n">YuI</span><span class="p">)</span>
            <span class="n">coef</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
            <span class="n">coef</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">XvI</span> <span class="o">=</span> <span class="p">(</span><span class="n">apI</span> <span class="o">+</span> <span class="n">amI</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>
            <span class="n">YvI</span> <span class="o">=</span> <span class="p">(</span><span class="n">apI</span> <span class="o">-</span> <span class="n">amI</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
            <span class="n">Lsmaj</span><span class="p">,</span> <span class="n">Lsmin</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">ut_cs2cep</span><span class="p">(</span><span class="n">XuI</span><span class="p">,</span> <span class="n">YuI</span><span class="p">,</span> <span class="n">XvI</span><span class="p">,</span> <span class="n">YvI</span><span class="p">)</span>
            <span class="n">coef</span><span class="o">.</span><span class="n">Lsmaj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">Lsmaj</span><span class="p">,</span> <span class="n">Lsmaj</span><span class="p">))</span>
            <span class="n">coef</span><span class="o">.</span><span class="n">Lsmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">Lsmin</span><span class="p">,</span> <span class="n">Lsmin</span><span class="p">))</span>
            <span class="n">coef</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta</span><span class="p">))</span>
            <span class="n">coef</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">coef</span><span class="o">.</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;conf_int&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">_confidence</span><span class="p">(</span>
            <span class="n">coef</span><span class="p">,</span> <span class="n">cnstit</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tin</span><span class="p">,</span> <span class="n">elor</span><span class="p">,</span> <span class="n">xraw</span><span class="p">,</span> <span class="n">xmod</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Xu</span><span class="p">,</span> <span class="n">Yu</span><span class="p">,</span> <span class="n">Xv</span><span class="p">,</span> <span class="n">Yv</span>
        <span class="p">)</span>

    <span class="c1"># Diagnostics.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodiagn&quot;</span><span class="p">]:</span>
        <span class="n">coef</span><span class="p">,</span> <span class="n">indPE</span> <span class="o">=</span> <span class="n">ut_diagn</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="c1"># Re-order constituents.</span>
    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;ordercnstit&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;ordercnstit&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;frq&quot;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;aux&quot;</span><span class="p">][</span><span class="s2">&quot;frq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;ordercnstit&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;snr&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodiagn&quot;</span><span class="p">]:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;diagn&quot;</span><span class="p">][</span><span class="s2">&quot;SNR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;twodim&quot;</span><span class="p">]:</span>
                    <span class="n">SNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmaj&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmin&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmaj_ci&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.96</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmin_ci&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.96</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">SNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;A_ci&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.96</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

                <span class="n">ind</span> <span class="o">=</span> <span class="n">SNR</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ilist</span> <span class="o">=</span> <span class="p">[</span><span class="n">constit_index_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;ordercnstit&quot;</span><span class="p">]]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ilist</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default: order by decreasing energy.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodiagn&quot;</span><span class="p">]:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">indPE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;twodim&quot;</span><span class="p">]:</span>
                <span class="n">PE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmaj&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmin&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">PE</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmaj&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;Lsmin&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">PE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PE</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coef</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">ind</span> <span class="o">=</span> <span class="n">PE</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">reorderlist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">twodim</span><span class="p">:</span>
        <span class="n">reorderlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;Lsmaj&quot;</span><span class="p">,</span> <span class="s2">&quot;Lsmin&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">conf_int</span><span class="p">:</span>
            <span class="n">reorderlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;Lsmaj_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;Lsmin_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;theta_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;g_ci&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reorderlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">conf_int</span><span class="p">:</span>
            <span class="n">reorderlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;A_ci&quot;</span><span class="p">,</span> <span class="s2">&quot;g_ci&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reorderlist</span><span class="p">:</span>
        <span class="n">coef</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>

    <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;aux&quot;</span><span class="p">][</span><span class="s2">&quot;frq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;aux&quot;</span><span class="p">][</span><span class="s2">&quot;frq&quot;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;aux&quot;</span><span class="p">][</span><span class="s2">&quot;lind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="s2">&quot;aux&quot;</span><span class="p">][</span><span class="s2">&quot;lind&quot;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;RunTimeDisp&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coef</span>


<span class="k">def</span> <span class="nf">_slvinit</span><span class="p">(</span><span class="n">tin</span><span class="p">,</span> <span class="n">uin</span><span class="p">,</span> <span class="n">vin</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Latitude must be supplied&quot;</span><span class="p">)</span>

    <span class="c1"># Supporting only 1-D arrays for now; we can add &quot;group&quot;</span>
    <span class="c1"># support later.</span>
    <span class="k">if</span> <span class="n">tin</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">uin</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">tin</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">uin</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;t and u must be 1-D arrays&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vin</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">uin</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;v must have the same shape as u&quot;</span><span class="p">)</span>

    <span class="n">opt</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">(</span><span class="n">twodim</span><span class="o">=</span><span class="p">(</span><span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># Step 0: apply epoch to time.</span>
    <span class="n">tin</span> <span class="o">=</span> <span class="n">_normalize_time</span><span class="p">(</span><span class="n">tin</span><span class="p">,</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">])</span>

    <span class="c1"># Step 1: remove invalid times from tin, uin, vin</span>
    <span class="n">tin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">tin</span><span class="p">)</span>
    <span class="n">uin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">uin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">vin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">tin</span><span class="p">):</span>
        <span class="n">goodmask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">tin</span><span class="p">)</span>
        <span class="n">uin</span> <span class="o">=</span> <span class="n">uin</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">goodmask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vin</span> <span class="o">=</span> <span class="n">vin</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">goodmask</span><span class="p">)</span>

    <span class="n">tin</span> <span class="o">=</span> <span class="n">tin</span><span class="o">.</span><span class="n">compressed</span><span class="p">()</span>  <span class="c1"># No longer masked.</span>

    <span class="c1"># Step 2: generate t, u, v from edited tin, uin, vin.</span>
    <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">uin</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">vin</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">uin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">vin</span><span class="p">),</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">goodmask</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tin</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">goodmask</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uin</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">goodmask</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vin</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">goodmask</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tin</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uin</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vin</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>

    <span class="c1"># Now t, u, v, tin are clean ndarrays; uin and vin are masked,</span>
    <span class="c1"># but don&#39;t necessarily have masked values.</span>

    <span class="c1"># Are the times equally spaced?</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tin</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
        <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;equi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># based on times; u/v can still have nans (&quot;gappy&quot;)</span>
        <span class="n">lor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">tin</span><span class="p">)</span>
        <span class="n">ntgood</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tin</span><span class="p">)</span>
        <span class="n">elor</span> <span class="o">=</span> <span class="n">lor</span> <span class="o">*</span> <span class="n">ntgood</span> <span class="o">/</span> <span class="p">(</span><span class="n">ntgood</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tref</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;equi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">elor</span> <span class="o">=</span> <span class="n">lor</span> <span class="o">*</span> <span class="n">nt</span> <span class="o">/</span> <span class="p">(</span><span class="n">nt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tref</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Options.</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;conf_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;cnstit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;notrend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;prefilt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodsatlint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodsatnone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;gwchlint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;gwchnone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;infer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;inferaprx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;rmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ols&quot;</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;tunrdn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;linci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nrlzn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;lsfrqosmp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nodiagn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;diagnplots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;diagnminsnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;ordercnstit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;runtimedisp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yyy&quot;</span>

    <span class="c1"># Update the default opt dictionary with the kwargs,</span>
    <span class="c1"># ensuring that every kwarg key matches a key in opt.</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solve: unrecognized input: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">tin</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tref</span><span class="p">,</span> <span class="n">lor</span><span class="p">,</span> <span class="n">elor</span><span class="p">,</span> <span class="n">opt</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">UTide 0.2.6.dev26+gdf2f77b documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">utide._solve</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Dan Codiga, Wesley Bowman, and contributors.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.2.
    </div>
  </body>
</html>